# SynthSense: Synthesis-aware REINVENT Rewards

**SynthSense** is a scoring component for [REINVENT4](https://github.com/MolecularAI/REINVENT4) that evaluates molecules based on their synthetic feasibility and route coherence using retrosynthetic analysis from [AiZynthFinder](https://github.com/MolecularAI/aizynthfinder).

Read the preprint here LINK MISSING

## Features

SynthSense provides multiple rewards to guide molecular generation:

- **SFScore**: Synthetic feasibility score combining stock availability, reaction preference and route complexity
- **RRScore**: Reference route similarity score using Tree Edit Distance (TED)
- **Route Popularity**: Promotes coherent synthetic routes within batches
- **Fill-a-Plate**: Promotes coherent synthetic routes across batches (route diversity filter)

## Prerequisites

SynthSense requires the following software:

1. **[REINVENT4](https://github.com/MolecularAI/REINVENT4)** - Molecular generation framework
2. **[AiZynthFinder](https://github.com/MolecularAI/aizynthfinder)** - Retrosynthetic planning tool
3. **[NameRxn](https://www.nextmovesoftware.com/namerxn.html)** (NextMove Software) - Reaction classification tool
   - **Commercial software** - purchase required from NextMove Software
   - Required for annotating reaction classes in AiZynthFinder
   - See `NAMERXN_SETUP.md` for detailed setup instructions

> **Note**: NameRxn is critical for SynthSense functionality as it provides reaction class annotations.

## Installation

### 1. Install Prerequisites

Ensure REINVENT4 and AiZynthFinder are installed and working in your environment.

### 2. Set up NameRxn

Follow the instructions in `NAMERXN_SETUP.md` to configure NameRxn for annotating AiZynthFinder retrosynthetic trees.

### 3. Install SynthSense

Copy `synthsense` directory into your REINVENT4 plugins directory:

```bash
# Assuming REINVENT4 is installed
cp -r synthsense /path/to/REINVENT4/reinvent_plugins/components/
```

## Usage

### Basic Configuration

Configure SynthSense in your REINVENT staged learning TOML file:

```toml
[[stage.scoring.component]]
[stage.scoring.component.Cazp2]
[[stage.scoring.component.Cazp2.endpoint]]
name = "SFScore"
params.number_of_steps = 3
params.reaction_step_coefficient = 0.9
params.stock_profile = "enamine_bb"
params.reactions_profile = "SelectedReactions"
params.time_limit_seconds = 60
params.score_to_extract = "sfscore"
weight = 1
```

### Available Endpoints

#### 1. SFScore (Synthesis Feasibility)
```toml
params.score_to_extract = "sfscore"
params.reaction_step_coefficient = 0.9
```

#### 2. RRScore (Reference Route)
```toml
params.score_to_extract = "rrscore"
params.reference_route_file = "reference_route.json"
```

#### 3. Route Popularity
```toml
params.score_to_extract = "route_popularity"
params.popularity_threshold = 1.0
params.penalty_multiplier = 0.5
```

#### 4. Fill-a-Plate
```toml
params.score_to_extract = "fill_a_plate"
params.bucket_threshold = 1000
params.min_steps_for_penalization = 1
params.penalization_enabled = true
```

### AiZynthFinder Configuration

Place your AiZynthFinder config in `configs/config_synthsense.yml`. See `examples/` for a complete setup.

## Examples

See the `examples/` directory for:
- `staged_learning.toml`: Complete REINVENT staged learning configuration
- `run.sh`: SLURM job submission script
- `reference_route_312_2110.json`: Example reference route

## Utilities

### Generate Reference Routes

Use `generate_route.py` to create reference route JSON files:

```bash
python generate_route.py -r 3.1.2 2.1.10 -o my_reference_route.json
```

## Architecture

SynthSense integrates with REINVENT4 through the plugin system:
1. Molecules are generated by REINVENT
2. SMILES are passed to AiZynthFinder for retrosynthetic analysis
3. SynthSense rewards extract different scores from synthetic trees
4. Scores guide the reinforcement learning process

## Citation

If you use SynthSense in your research, please cite:

- SynthSense (preprint not published yet)

- Loeffler, H. H.; He, J.; Tibo, A.; Janet, J. P.; Voronov, A.; Mervin, L. H.; Engkvist, O.
REINVENT 4: Modern AI–Driven Generative Molecule Design. J. Cheminf. 2024, 16 (1), 20.

- Genheden, S.; Thakkar, A.; Chadimová, V.; Reymond, J.-L.; Engkvist, O.; Bjerrum, E.
AiZynthFinder: A Fast, Robust and Flexible Open-Source Software for Retrosynthetic Planning. J. Cheminf. 2020, 12, 70.

- NextMove Software.
NameRxn (Expert System for Named Reaction Identification and Classification). 2022.
